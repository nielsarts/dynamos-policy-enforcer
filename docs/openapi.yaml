openapi: 3.0.3
info:
  title: DYNAMOS Policy Enforcer API
  description: |
    API for policy enforcement in the DYNAMOS system.
    
    This API provides two levels of abstraction:
    
    ## Policy Enforcer API (`/policy-enforcer/*`)
    High-level, reasoner-agnostic interface for policy validation. This API is designed
    to work with different reasoning engines (eFLINT, Symboleo, JSON-based, etc.) through
    a common interface. Use these endpoints for:
    - **Allowed Clauses**: Query what request types, datasets, archetypes, and compute providers
      are allowed for a specific requester at an organization
    - **Request Validation**: Check if a specific data request is permitted by the policy
    
    ## eFLINT API (`/eflint/*`)
    Low-level interface for direct eFLINT server management. Use these endpoints for:
    - **Instance Management**: Start, stop, and monitor eFLINT server instances
    - **Commands**: Send raw commands to the eFLINT server
    - **State Management (POC)**: Export, import, and checkpoint eFLINT execution graphs
    
    ## Architecture
    ```
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                           HTTP/gRPC Layer                                │
    ├─────────────────────────────────────────────────────────────────────────┤
    │  Policy Enforcer API              │  eFLINT API                         │
    │  /policy-enforcer/*               │  /eflint/*                          │
    │  (Reasoner-agnostic)              │  (eFLINT-specific)                  │
    └────────────────┬──────────────────┴───────────────────┬─────────────────┘
                     │                                       │
                     ▼                                       │
    ┌─────────────────────────────────┐                      │
    │      Reasoner Interface         │                      │
    │  - eFLINT Reasoner              │                      │
    │  - (Future: Symboleo, JSON)     │◄─────────────────────┘
    └────────────────┬────────────────┘
                     │
                     ▼
    ┌─────────────────────────────────┐
    │        eFLINT Manager           │
    │   (Process lifecycle, TCP)      │
    └────────────────┬────────────────┘
                     │
                     ▼ TCP
    ┌─────────────────────────────────┐
    │       eFLINT Server             │
    │    (external process)           │
    └─────────────────────────────────┘
    ```
  version: 2.0.0
  contact:
    name: Niels Arts

servers:
  - url: http://localhost:8912
    description: Local development server

paths:
  # ---------------------------------------------------------------------------
  # Instance Management Endpoints
  # ---------------------------------------------------------------------------
  /eflint/status:
    get:
      summary: Get instance status
      description: Returns the current status of the eFLINT server instance
      operationId: getStatus
      tags:
        - Instance Management
      responses:
        '200':
          description: Status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  /eflint/start:
    post:
      summary: Start instance
      description: |
        Starts the eFLINT server instance with the given model.
        
        If an instance is already running:
        - With `force=false` (default): Returns 409 Conflict
        - With `force=true`: Stops the existing instance and starts a new one
      operationId: startInstance
      tags:
        - Instance Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartRequest'
            examples:
              simple:
                summary: Start with model
                value:
                  model_location: "/path/to/model.eflint"
              force:
                summary: Force restart with new model
                value:
                  model_location: "/path/to/model.eflint"
                  force: true
      responses:
        '200':
          description: Instance started successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '400':
          description: Bad request - model_location is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Instance already running (use force=true to restart)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/stop:
    post:
      summary: Stop instance
      description: Stops the running eFLINT server instance
      operationId: stopInstance
      tags:
        - Instance Management
      responses:
        '200':
          description: Instance stopped successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '404':
          description: No instance running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/command:
    post:
      summary: Send command
      description: |
        Sends a command to the eFLINT server instance.
        
        The `command` field accepts two formats:
        - **Object format** (recommended): Pass the command as a JSON object directly. No escaping needed.
        - **String format** (legacy): Pass the command as an escaped JSON string.
        
        Using the object format avoids the need to escape double quotes in eFLINT phrases.
      operationId: sendCommand
      tags:
        - Instance Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
            examples:
              # ---------------------------------------------------------------------------
              # Command type: facts, status, create-export
              # ---------------------------------------------------------------------------
              facts:
                summary: Get facts
                description: Returns the current facts from the eFLINT state.
                value:
                  command:
                    command: facts
              status:
                summary: Get eFLINT status
                value:
                  command:
                    command: status
              create_export:
                summary: Create export
                value:
                  command:
                    command: create-export
              # ---------------------------------------------------------------------------
              # Command type: phrase (object and string format)
              # ---------------------------------------------------------------------------
              phrase_object:
                summary: Execute a phrase (object format - recommended)
                description: |
                  With object format, quotes in the eFLINT text are just regular JSON string quotes.
                  No double-escaping needed.
                value:
                  command:
                    command: phrase
                    text: '+example-fact("value").'
              phrase_string:
                summary: Execute a phrase (string format - legacy)
                description: |
                  With string format, you need to escape the outer JSON string AND the inner JSON,
                  leading to double-escaped quotes (\\\" instead of just \").
                value:
                  command: '{"command": "phrase", "text": "+example-fact(\\\"value\\\")."}'
              # ---------------------------------------------------------------------------
              # Command type: enabled
              # ---------------------------------------------------------------------------
              enabled_object:
                summary: Query if action is enabled (object format)
                value:
                  command:
                    command: enabled
                    value:
                      tagged-type: Act
                      fact-type: submit-request
                      value:
                        - tagged-type: String
                          fact-type: requester
                          value: jorrit.stutterheim@cloudnation.nl
                          textual: "\"jorrit.stutterheim@cloudnation.nl\""
                        - tagged-type: String
                          fact-type: organization
                          value: VU
                          textual: "\"VU\""
                        - tagged-type: String
                          fact-type: request-type
                          value: sqlDataRequest
                          textual: "\"sqlDataRequest\""
                        - tagged-type: String
                          fact-type: data-set
                          value: wageGap
                          textual: "\"wageGap\""
                        - tagged-type: String
                          fact-type: archetype
                          value: computeToData
                          textual: "\"computeToData\""
                        - tagged-type: String
                          fact-type: compute-provider
                          value: SURF
                          textual: "\"SURF\""
                      textual: "submit-request(\"jorrit.stutterheim@cloudnation.nl\", \"VU\", \"sqlDataRequest\", \"wageGap\", \"computeToData\", \"SURF\")"
              # ---------------------------------------------------------------------------
              # Action: authorize-request-type (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_authorize_request_type_structured:
                summary: Action authorize-request-type (structured form)
                value:
                  command:
                    command: action
                    act-type: authorize-request-type
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["sqlDataRequest"]
              action_authorize_request_type_value:
                summary: Action authorize-request-type (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: authorize-request-type
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: rtype
                          value: sqlDataRequest
              action_authorize_request_type_phrase:
                summary: Action authorize-request-type (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'authorize-request-type("VU", "jorrit.stutterheim@cloudnation.nl", "sqlDataRequest").'
              # ---------------------------------------------------------------------------
              # Action: revoke-request-type (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_revoke_request_type_structured:
                summary: Action revoke-request-type (structured form)
                value:
                  command:
                    command: action
                    act-type: revoke-request-type
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["sqlDataRequest"]
              action_revoke_request_type_value:
                summary: Action revoke-request-type (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: revoke-request-type
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: rtype
                          value: sqlDataRequest
              action_revoke_request_type_phrase:
                summary: Action revoke-request-type (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'revoke-request-type("VU", "jorrit.stutterheim@cloudnation.nl", "sqlDataRequest").'
              # ---------------------------------------------------------------------------
              # Action: authorize-data-set (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_authorize_data_set_structured:
                summary: Action authorize-data-set (structured form)
                value:
                  command:
                    command: action
                    act-type: authorize-data-set
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["wageGap"]
              action_authorize_data_set_value:
                summary: Action authorize-data-set (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: authorize-data-set
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: dataset
                          value: wageGap
              action_authorize_data_set_phrase:
                summary: Action authorize-data-set (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'authorize-data-set("VU", "jorrit.stutterheim@cloudnation.nl", "wageGap").'
              # ---------------------------------------------------------------------------
              # Action: revoke-data-set (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_revoke_data_set_structured:
                summary: Action revoke-data-set (structured form)
                value:
                  command:
                    command: action
                    act-type: revoke-data-set
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["wageGap"]
              action_revoke_data_set_value:
                summary: Action revoke-data-set (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: revoke-data-set
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: dataset
                          value: wageGap
              action_revoke_data_set_phrase:
                summary: Action revoke-data-set (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'revoke-data-set("VU", "jorrit.stutterheim@cloudnation.nl", "wageGap").'
              # ---------------------------------------------------------------------------
              # Action: authorize-archetype (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_authorize_archetype_structured:
                summary: Action authorize-archetype (structured form)
                value:
                  command:
                    command: action
                    act-type: authorize-archetype
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["computeToData"]
              action_authorize_archetype_value:
                summary: Action authorize-archetype (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: authorize-archetype
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: arch
                          value: computeToData
              action_authorize_archetype_phrase:
                summary: Action authorize-archetype (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'authorize-archetype("VU", "jorrit.stutterheim@cloudnation.nl", "computeToData").'
              # ---------------------------------------------------------------------------
              # Action: revoke-archetype (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_revoke_archetype_structured:
                summary: Action revoke-archetype (structured form)
                value:
                  command:
                    command: action
                    act-type: revoke-archetype
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["computeToData"]
              action_revoke_archetype_value:
                summary: Action revoke-archetype (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: revoke-archetype
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: arch
                          value: computeToData
              action_revoke_archetype_phrase:
                summary: Action revoke-archetype (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'revoke-archetype("VU", "jorrit.stutterheim@cloudnation.nl", "computeToData").'
              # ---------------------------------------------------------------------------
              # Action: authorize-compute-provider (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_authorize_compute_provider_structured:
                summary: Action authorize-compute-provider (structured form)
                value:
                  command:
                    command: action
                    act-type: authorize-compute-provider
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["SURF"]
              action_authorize_compute_provider_value:
                summary: Action authorize-compute-provider (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: authorize-compute-provider
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: provider
                          value: SURF
              action_authorize_compute_provider_phrase:
                summary: Action authorize-compute-provider (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'authorize-compute-provider("VU", "jorrit.stutterheim@cloudnation.nl", "SURF").'
              # ---------------------------------------------------------------------------
              # Action: revoke-compute-provider (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_revoke_compute_provider_structured:
                summary: Action revoke-compute-provider (structured form)
                value:
                  command:
                    command: action
                    act-type: revoke-compute-provider
                    actor: VU
                    recipient: jorrit.stutterheim@cloudnation.nl
                    objects: ["SURF"]
              action_revoke_compute_provider_value:
                summary: Action revoke-compute-provider (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: revoke-compute-provider
                      arguments:
                        - fact-type: org
                          value: VU
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: provider
                          value: SURF
              action_revoke_compute_provider_phrase:
                summary: Action revoke-compute-provider (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'revoke-compute-provider("VU", "jorrit.stutterheim@cloudnation.nl", "SURF").'
              # ---------------------------------------------------------------------------
              # Action: submit-request (structured, value, phrase)
              # ---------------------------------------------------------------------------
              action_submit_request_structured:
                summary: Action submit-request (structured form)
                description: submit-request has actor=requester, recipient=organization; objects are request-type, data-set, archetype, compute-provider.
                value:
                  command:
                    command: action
                    act-type: submit-request
                    actor: jorrit.stutterheim@cloudnation.nl
                    recipient: VU
                    objects:
                      - sqlDataRequest
                      - wageGap
                      - computeToData
                      - SURF
              action_submit_request_value:
                summary: Action submit-request (value form)
                value:
                  command:
                    command: action
                    value:
                      fact-type: submit-request
                      arguments:
                        - fact-type: req
                          value: jorrit.stutterheim@cloudnation.nl
                        - fact-type: org
                          value: VU
                        - fact-type: rtype
                          value: sqlDataRequest
                        - fact-type: dataset
                          value: wageGap
                        - fact-type: arch
                          value: computeToData
                        - fact-type: provider
                          value: SURF
              action_submit_request_phrase:
                summary: Action submit-request (phrase command)
                value:
                  command:
                    command: phrase
                    text: 'submit-request("jorrit.stutterheim@cloudnation.nl", "VU", "sqlDataRequest", "wageGap", "computeToData", "SURF").'
      responses:
        '200':
          description: Command executed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'

  # ---------------------------------------------------------------------------
  # State Management Endpoints (POC)
  # ---------------------------------------------------------------------------
  /eflint/state:
    get:
      summary: Get current state
      description: Retrieves the current execution graph state of the eFLINT instance
      operationId: getState
      tags:
        - State Management
      responses:
        '200':
          description: State retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StateResponse'
        '503':
          description: Instance is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/state/export:
    post:
      summary: Export state
      description: |
        Exports the current eFLINT execution graph state for later import.
        Returns a SavedState object with metadata that can be stored and restored.
      operationId: exportState
      tags:
        - State Management
      responses:
        '200':
          description: State exported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportStateResponse'
        '503':
          description: Instance is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/state/import:
    post:
      summary: Import state
      description: |
        Imports a previously exported eFLINT execution graph state.
        
        > **Note**: Due to limitations in the eFLINT server's load-export functionality,
        > full state restoration may not work in all cases.
      operationId: importState
      tags:
        - State Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImportStateRequest'
      responses:
        '200':
          description: State imported successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Bad request - state is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Instance is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/state/checkpoint:
    post:
      summary: Create checkpoint
      description: Creates a named checkpoint of the current state that can be restored later
      operationId: createCheckpoint
      tags:
        - State Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckpointRequest'
            example:
              name: "before-test"
      responses:
        '200':
          description: Checkpoint created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckpointCreatedResponse'
        '400':
          description: Bad request - name is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Instance is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/state/checkpoint/restore:
    post:
      summary: Restore checkpoint
      description: |
        Restores a previously created checkpoint.
        
        > **Note**: Due to a bug in the eFLINT server, full state restoration may not work.
        > In that case, the instance will be restarted to the initial model state.
      operationId: restoreCheckpoint
      tags:
        - State Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckpointRequest'
            example:
              name: "before-test"
      responses:
        '200':
          description: Checkpoint restored successfully (or partially with warning)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckpointRestoredResponse'
        '400':
          description: Bad request - name is required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Instance is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/state/checkpoints:
    get:
      summary: List checkpoints
      description: Lists all available checkpoints
      operationId: listCheckpoints
      tags:
        - State Management
      responses:
        '200':
          description: Checkpoints listed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckpointListResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /eflint/state/checkpoint/{name}:
    delete:
      summary: Delete checkpoint
      description: Deletes a checkpoint by name
      operationId: deleteCheckpoint
      tags:
        - State Management
      parameters:
        - name: name
          in: path
          required: true
          description: The name of the checkpoint to delete
          schema:
            type: string
          example: "before-test"
      responses:
        '200':
          description: Checkpoint deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckpointDeletedResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ---------------------------------------------------------------------------
  # Health Endpoints
  # ---------------------------------------------------------------------------
  /health:
    get:
      summary: Health check
      description: Returns the health status of the service
      operationId: healthCheck
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"

  # ---------------------------------------------------------------------------
  # Policy Enforcer Endpoints (Reasoner-Agnostic)
  # ---------------------------------------------------------------------------
  /policy-enforcer/info:
    get:
      summary: Get reasoner info
      description: Returns information about the active reasoning engine
      operationId: getReasonerInfo
      tags:
        - Policy Enforcer
      responses:
        '200':
          description: Reasoner info retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReasonerInfoResponse'

  /policy-enforcer/allowed-request-types:
    get:
      summary: Get allowed request types
      description: |
        Returns all request types that are allowed for a requester at an organization.
        This is a reasoner-agnostic endpoint that works with any configured reasoning engine.
      operationId: getAllowedRequestTypes
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationParam'
        - $ref: '#/components/parameters/RequesterParam'
      responses:
        '200':
          description: Allowed request types retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllowedClausesResponse'
        '400':
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/allowed-data-sets:
    get:
      summary: Get allowed data sets
      description: |
        Returns all datasets that are allowed for a requester at an organization.
        This is a reasoner-agnostic endpoint that works with any configured reasoning engine.
      operationId: getAllowedDataSets
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationParam'
        - $ref: '#/components/parameters/RequesterParam'
      responses:
        '200':
          description: Allowed data sets retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllowedClausesResponse'
        '400':
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/allowed-archetypes:
    get:
      summary: Get allowed archetypes
      description: |
        Returns all archetypes that are allowed for a requester at an organization.
        This is a reasoner-agnostic endpoint that works with any configured reasoning engine.
      operationId: getAllowedArchetypes
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationParam'
        - $ref: '#/components/parameters/RequesterParam'
      responses:
        '200':
          description: Allowed archetypes retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllowedClausesResponse'
        '400':
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/allowed-compute-providers:
    get:
      summary: Get allowed compute providers
      description: |
        Returns all compute providers that are allowed for a requester at an organization.
        This is a reasoner-agnostic endpoint that works with any configured reasoning engine.
      operationId: getAllowedComputeProviders
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationParam'
        - $ref: '#/components/parameters/RequesterParam'
      responses:
        '200':
          description: Allowed compute providers retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllowedClausesResponse'
        '400':
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/allowed-clauses:
    get:
      summary: Get all allowed clauses
      description: |
        Returns all allowed clauses (request types, data sets, archetypes, and compute providers)
        for a requester at an organization in a single request.
        This is a convenience endpoint that combines all individual allowed-* endpoints.
      operationId: getAllAllowedClauses
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationParam'
        - $ref: '#/components/parameters/RequesterParam'
      responses:
        '200':
          description: All allowed clauses retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AllAllowedClausesResponse'
        '400':
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/validate:
    post:
      summary: Validate request
      description: |
        Validates whether a specific data request is allowed according to the policy.
        
        This endpoint checks all aspects of the request:
        - Request type is allowed
        - Data set is allowed
        - Archetype is allowed
        - Compute provider is allowed
        - The combination is permitted by the agreement
        
        This is the main endpoint for policy enforcement in DYNAMOS.
      operationId: validateRequest
      tags:
        - Policy Enforcer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateRequestParams'
            examples:
              allowed_request:
                summary: Request that should be allowed
                value:
                  organization: "VU"
                  requester: "jorrit.stutterheim@cloudnation.nl"
                  request_type: "sqlDataRequest"
                  data_set: "wageGap"
                  archetype: "dataThroughTtp"
                  compute_provider: "SURF"
              denied_request:
                summary: Request that should be denied (computeToData was revoked)
                value:
                  organization: "VU"
                  requester: "jorrit.stutterheim@cloudnation.nl"
                  request_type: "sqlDataRequest"
                  data_set: "wageGap"
                  archetype: "computeToData"
                  compute_provider: "SURF"
      responses:
        '200':
          description: Validation completed (check 'allowed' field for result)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResponse'
        '400':
          description: Bad request - missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/available-archetypes:
    get:
      summary: Get available archetypes for an organization
      description: |
        Returns all archetypes that are available at an organization level (not requester-specific).
        These are archetypes that the organization has configured as options,
        regardless of which requesters have been authorized to use them.
      operationId: getAvailableArchetypes
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationOnlyParam'
      responses:
        '200':
          description: Available archetypes retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailableValuesResponse'
        '400':
          description: Bad request - missing organization parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /policy-enforcer/available-compute-providers:
    get:
      summary: Get available compute providers for an organization
      description: |
        Returns all compute providers that are available at an organization level (not requester-specific).
        These are providers that the organization has configured as options,
        regardless of which requesters have been authorized to use them.
      operationId: getAvailableComputeProviders
      tags:
        - Policy Enforcer
      parameters:
        - $ref: '#/components/parameters/OrganizationOnlyParam'
      responses:
        '200':
          description: Available compute providers retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AvailableComputeProvidersResponse'
        '400':
          description: Bad request - missing organization parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Reasoner is not running
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

# -----------------------------------------------------------------------------
# Components
# -----------------------------------------------------------------------------
components:
  # ---------------------------------------------------------------------------
  # Reusable Parameters
  # ---------------------------------------------------------------------------
  parameters:
    OrganizationParam:
      name: organization
      in: query
      required: true
      description: The organization/steward identifier
      schema:
        type: string
      example: VU

    RequesterParam:
      name: requester
      in: query
      required: true
      description: The requester/user identifier (typically an email)
      schema:
        type: string
      example: jorrit.stutterheim@cloudnation.nl

    OrganizationOnlyParam:
      name: organization
      in: query
      required: true
      description: The organization identifier
      schema:
        type: string
      example: VU

  # ---------------------------------------------------------------------------
  # Schemas
  # ---------------------------------------------------------------------------
  schemas:
    # -------------------------------------------------------------------------
    # Instance Management Schemas
    # -------------------------------------------------------------------------
    StatusResponse:
      type: object
      properties:
        running:
          type: boolean
          description: Whether the instance is running
          example: true
        port:
          type: integer
          description: The port the instance is running on
          example: 8123
        model_location:
          type: string
          description: The path to the model file
          example: "/path/to/model.eflint"

    StartRequest:
      type: object
      required:
        - model_location
      properties:
        model_location:
          type: string
          description: Path to the eFLINT model file
          example: "/path/to/model.eflint"
        force:
          type: boolean
          description: Force restart if an instance is already running
          default: false
          example: false

    CommandRequest:
      type: object
      required:
        - command
      properties:
        command:
          description: |
            The command to send to the eFLINT server.
            Can be either:
            - A JSON object (recommended): Will be serialized before sending. Quotes in strings only need standard JSON escaping.
            - A JSON string (legacy): Will be used directly. Requires double-escaping for quotes.
          oneOf:
            - type: object
              description: Command as JSON object (recommended)
              additionalProperties: true
              example:
                command: enabled
                value:
                  fact-type: submit-request
                  value:
                    - fact-type: req
                      value: jorrit.stutterheim@cloudnation.nl
                    - fact-type: org
                      value: VU
                    - fact-type: rtype
                      value: sqlDataRequest
                    - fact-type: dataset
                      value: wageGap
                    - fact-type: arch
                      value: computeToData
                    - fact-type: provider
                      value: SURF
            - type: string
              description: Command as JSON string (legacy, requires double-escaping)
              example: '{"command": "phrase", "text": "+example-fact(\\\"value\\\")."}'

    CommandResponse:
      type: object
      properties:
        response:
          type: object
          description: The parsed JSON response from eFLINT

    # -------------------------------------------------------------------------
    # Policy Enforcer Schemas
    # -------------------------------------------------------------------------
    ReasonerInfoResponse:
      type: object
      properties:
        name:
          type: string
          description: Name/type of the active reasoner
          example: "eflint"
        running:
          type: boolean
          description: Whether the reasoner is operational
          example: true

    AllowedClausesResponse:
      type: object
      properties:
        organization:
          type: string
          description: The organization/steward identifier
          example: VU
        requester:
          type: string
          description: The requester/user identifier
          example: jorrit.stutterheim@cloudnation.nl
        values:
          type: array
          items:
            type: string
          description: List of allowed values
          example: ["sqlDataRequest", "genericRequest"]

    AllAllowedClausesResponse:
      type: object
      properties:
        organization:
          type: string
          description: The organization/steward identifier
          example: VU
        requester:
          type: string
          description: The requester/user identifier
          example: jorrit.stutterheim@cloudnation.nl
        request_types:
          type: array
          items:
            type: string
          description: List of allowed request types
          example: ["sqlDataRequest", "genericRequest"]
        data_sets:
          type: array
          items:
            type: string
          description: List of allowed datasets
          example: ["wageGap"]
        archetypes:
          type: array
          items:
            type: string
          description: List of allowed archetypes
          example: ["dataThroughTtp", "reproducableScience"]
        compute_providers:
          type: array
          items:
            type: string
          description: List of allowed compute providers
          example: ["SURF"]

    ValidateRequestParams:
      type: object
      required:
        - organization
        - requester
        - request_type
        - data_set
        - archetype
        - compute_provider
      properties:
        organization:
          type: string
          description: The data steward organization
          example: "VU"
        requester:
          type: string
          description: The user making the request
          example: "jorrit.stutterheim@cloudnation.nl"
        request_type:
          type: string
          description: Type of request
          example: "sqlDataRequest"
        data_set:
          type: string
          description: The dataset being requested
          example: "wageGap"
        archetype:
          type: string
          description: The processing archetype
          example: "dataThroughTtp"
        compute_provider:
          type: string
          description: Where the computation runs
          example: "SURF"

    ValidationResponse:
      type: object
      properties:
        allowed:
          type: boolean
          description: Whether the request is permitted
          example: true
        reason:
          type: string
          description: Explanation for the decision
          example: "Request is permitted by the agreement"
        organization:
          type: string
          description: The organization checked
          example: "VU"
        requester:
          type: string
          description: The requester checked
          example: "jorrit.stutterheim@cloudnation.nl"
        request_type:
          type: string
          description: The request type checked
          example: "sqlDataRequest"
        data_set:
          type: string
          description: The dataset checked
          example: "wageGap"
        archetype:
          type: string
          description: The archetype checked
          example: "dataThroughTtp"
        compute_provider:
          type: string
          description: The compute provider checked
          example: "SURF"

    AvailableValuesResponse:
      type: object
      properties:
        organization:
          type: string
          description: The organization identifier
          example: "VU"
        archetypes:
          type: array
          items:
            type: string
          description: List of available archetypes
          example: ["computeToData", "dataThroughTtp", "reproducableScience"]

    AvailableComputeProvidersResponse:
      type: object
      properties:
        organization:
          type: string
          description: The organization identifier
          example: "VU"
        compute_providers:
          type: array
          items:
            type: string
          description: List of available compute providers
          example: ["SURF", "otherCompany"]

    # -------------------------------------------------------------------------
    # State Management Schemas
    # -------------------------------------------------------------------------
    StateResponse:
      type: object
      properties:
        state:
          type: object
          description: The current execution graph state

    SavedState:
      type: object
      properties:
        id:
          type: string
          description: Unique identifier for the saved state
          example: "state-1704470400000000000"
        model_location:
          type: string
          description: The model location when the state was saved
          example: "/eflint/dynamos-agreement.eflint"
        graph:
          type: object
          description: The eFLINT execution graph
        saved_at:
          type: string
          format: date-time
          description: When the state was saved
          example: "2026-01-05T15:30:00Z"

    ExportStateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        state:
          $ref: '#/components/schemas/SavedState'

    ImportStateRequest:
      type: object
      required:
        - state
      properties:
        state:
          $ref: '#/components/schemas/SavedState'

    CheckpointRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: The name of the checkpoint
          example: "before-test"

    CheckpointCreatedResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        checkpoint:
          type: string
          description: The name of the created checkpoint
          example: "before-test"
        state_id:
          type: string
          description: The ID of the saved state
          example: "state-1704470400000000000"
        saved_at:
          type: string
          format: date-time
          example: "2026-01-05T15:30:00Z"

    CheckpointRestoredResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "checkpoint restored successfully"
        restored:
          type: string
          description: The name of the restored checkpoint
          example: "before-test"

    CheckpointListResponse:
      type: object
      properties:
        checkpoints:
          type: array
          items:
            type: string
          description: List of checkpoint names
          example: ["before-test", "initial-state"]

    CheckpointDeletedResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "checkpoint deleted successfully"
        deleted:
          type: string
          description: The name of the deleted checkpoint
          example: "before-test"

    # -------------------------------------------------------------------------
    # Common Schemas
    # -------------------------------------------------------------------------
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: "no instance running"

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "operation completed successfully"

# -----------------------------------------------------------------------------
# Tags
# -----------------------------------------------------------------------------
tags:
  - name: Policy Enforcer
    description: |
      Reasoner-agnostic policy enforcement endpoints. Use these for validating requests
      and querying allowed clauses. Works with any configured reasoning engine (eFLINT,
      Symboleo, JSON-based, etc.).
  - name: Instance Management
    description: |
      Low-level endpoints for managing the eFLINT server instance lifecycle.
      These are eFLINT-specific and should be used for debugging or direct server control.
  - name: State Management
    description: |
      Endpoints for getting, exporting, importing, and managing eFLINT state checkpoints (POC).
      These are eFLINT-specific and experimental.
  - name: Health
    description: Health check endpoints
